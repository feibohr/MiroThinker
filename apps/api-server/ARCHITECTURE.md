# MiroThinker API Server æ¶æ„æ–‡æ¡£

## ğŸ“ é¡¹ç›®ç»“æ„

```
apps/api-server/
â”œâ”€â”€ main.py                      # FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ routers/                     # API è·¯ç”±
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ chat.py                 # /v1/chat/completions ç«¯ç‚¹
â”œâ”€â”€ services/                    # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ pipeline_manager.py     # Pipeline ç»„ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ stream_handler.py       # äº‹ä»¶æµå¤„ç†ï¼ˆä» gradio-demo è¿ç§»ï¼‰
â”‚   â”œâ”€â”€ data_filter.py          # æ•°æ®è¿‡æ»¤ï¼ˆä» gradio-demo è¿ç§»ï¼‰
â”‚   â””â”€â”€ openai_adapter.py       # OpenAI æ ¼å¼è½¬æ¢
â”œâ”€â”€ pyproject.toml              # é¡¹ç›®ä¾èµ–é…ç½®
â”œâ”€â”€ Dockerfile                  # Docker é•œåƒ
â”œâ”€â”€ docker-compose.yml          # Docker ç¼–æ’
â”œâ”€â”€ nginx.conf                  # Nginx é…ç½®ï¼ˆåå‘ä»£ç†ã€é™æµï¼‰
â”œâ”€â”€ start.sh                    # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_api.py                 # API æµ‹è¯•è„šæœ¬
â”œâ”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ QUICKSTART.md               # å¿«é€Ÿå¼€å§‹
â”œâ”€â”€ ARCHITECTURE.md             # æ¶æ„æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â””â”€â”€ logs/                       # æ—¥å¿—ç›®å½•
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Client (å‰ç«¯/SDK)               â”‚
â”‚   - React/Vue å‰ç«¯                       â”‚
â”‚   - OpenAI Python SDK                   â”‚
â”‚   - curl/httpx                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTP/SSE
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      API Layer (FastAPI)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  routers/chat.py                 â”‚   â”‚
â”‚  â”‚  - POST /v1/chat/completions     â”‚   â”‚
â”‚  â”‚  - OpenAI å…¼å®¹æ¥å£               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  services/                       â”‚   â”‚
â”‚  â”‚  - pipeline_manager             â”‚   â”‚
â”‚  â”‚  - stream_handler (äº‹ä»¶æµ)      â”‚   â”‚
â”‚  â”‚  - data_filter (æ•°æ®æ¸…æ´—)       â”‚   â”‚
â”‚  â”‚  - openai_adapter (æ ¼å¼è½¬æ¢)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ è°ƒç”¨
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Core Layer (miroflow-agent)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Pipeline                        â”‚   â”‚
â”‚  â”‚  - execute_task_pipeline()       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Orchestrator                    â”‚   â”‚
â”‚  â”‚  - run_main_agent()              â”‚   â”‚
â”‚  â”‚  - åè°ƒ LLM + å·¥å…·æ‰§è¡Œ           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tool Manager (miroflow-tools)   â”‚   â”‚
â”‚  â”‚  - Google æœç´¢ã€çˆ¬è™«ã€ä»£ç æ‰§è¡Œ   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµ

### æµå¼è¯·æ±‚æµç¨‹

```
1. Client å‘é€è¯·æ±‚
   POST /v1/chat/completions
   {
     "model": "mirothinker",
     "messages": [...],
     "stream": true
   }
   â†“
2. routers/chat.py
   - è§£æè¯·æ±‚
   - æå–ç”¨æˆ·é—®é¢˜
   - è°ƒç”¨ _stream_chat_completion()
   â†“
3. services/stream_handler.py
   - åˆ›å»ºå¼‚æ­¥é˜Ÿåˆ—
   - åœ¨ç‹¬ç«‹çº¿ç¨‹å¯åŠ¨ Pipeline
   - æµå¼è¿”å›äº‹ä»¶
   â†“
4. services/data_filter.py
   - è¿‡æ»¤æœç´¢ç»“æœï¼ˆä¿ç•™ title/linkï¼‰
   - æ¸…ç†çˆ¬è™«å†…å®¹
   - ç§»é™¤ä¸å¿…è¦ä¿¡æ¯
   â†“
5. services/openai_adapter.py
   - å°† MiroThinker äº‹ä»¶è½¬æ¢ä¸º OpenAI chunk
   - æ ¼å¼åŒ–å·¥å…·è°ƒç”¨ã€æœç´¢ç»“æœç­‰
   â†“
6. è¿”å›ç»™ Clientï¼ˆSSE æ ¼å¼ï¼‰
   data: {"id":"chatcmpl-xxx",...,"delta":{"content":"..."}}
   data: [DONE]
```

## ğŸ§© æ ¸å¿ƒç»„ä»¶

### 1. Pipeline Manager (`services/pipeline_manager.py`)

**èŒè´£ï¼š**
- åˆå§‹åŒ– miroflow-agent Pipeline ç»„ä»¶
- åŠ è½½ Hydra é…ç½®
- ç®¡ç†å·¥å…·å®šä¹‰ç¼“å­˜
- ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å…³é”®æ–¹æ³•ï¼š**
- `initialize()`: åˆå§‹åŒ– Pipeline
- `_load_config()`: åŠ è½½é…ç½®
- `cleanup()`: æ¸…ç†èµ„æº

### 2. Stream Handler (`services/stream_handler.py`)

**èŒè´£ï¼š**
- æ‰§è¡Œç ”ç©¶ä»»åŠ¡
- æµå¼è¿”å›äº‹ä»¶
- çº¿ç¨‹å®‰å…¨çš„å¼‚æ­¥é˜Ÿåˆ—ç®¡ç†

**ä» gradio-demo è¿ç§»ï¼š**
- `stream_events_optimized()` â†’ `stream_research()`
- `ThreadSafeAsyncQueue` 
- Pipeline çº¿ç¨‹æ‰§è¡Œé€»è¾‘

### 3. Data Filter (`services/data_filter.py`)

**èŒè´£ï¼š**
- è¿‡æ»¤å’Œæ¸…æ´—äº‹ä»¶æ•°æ®
- å‡å°‘ä¼ è¾“æ•°æ®é‡
- ä¿æŠ¤æ•æ„Ÿä¿¡æ¯

**ä» gradio-demo è¿ç§»ï¼š**
- `filter_message()`
- `filter_google_search_organic()`
- `is_scrape_error()`

### 4. OpenAI Adapter (`services/openai_adapter.py`)

**èŒè´£ï¼š**
- å°† MiroThinker äº‹ä»¶è½¬æ¢ä¸º OpenAI æ ¼å¼
- åˆ›å»ºæµå¼ chunk
- æ ¼å¼åŒ–ä¸åŒç±»å‹çš„äº‹ä»¶

**äº‹ä»¶æ˜ å°„ï¼š**
```python
MiroThinker Event          â†’  OpenAI Chunk
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
start_of_agent             â†’  delta: {"content": "### ğŸ¤– Agent Started\n"}
tool_call (google_search)  â†’  delta: {"content": "### ğŸ” Search Results\n..."}
tool_call (show_text)      â†’  delta: {"content": "..."}
message (delta)            â†’  delta: {"content": "..."}
end_of_agent               â†’  delta: {"content": "### âœ… Completed\n"}
error                      â†’  delta: {"content": "âŒ Error: ..."}
heartbeat                  â†’  (è·³è¿‡)
```

## ğŸ” å®‰å…¨ç‰¹æ€§

### 1. CORS é…ç½®
```python
# main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2. Nginx é™æµï¼ˆå¯é€‰ï¼‰
```nginx
# nginx.conf
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req zone=api_limit burst=20 nodelay;
```

### 3. å¥åº·æ£€æŸ¥
```python
@app.get("/health")
async def health():
    return {"status": "healthy"}
```

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æ—¥å¿—ç»“æ„
```
logs/
â”œâ”€â”€ api-server/
â”‚   â””â”€â”€ task_{task_id}.json     # Pipeline æ‰§è¡Œæ—¥å¿—
â””â”€â”€ server.log                  # API æœåŠ¡å™¨æ—¥å¿—
```

### æ—¥å¿—å†…å®¹
- è¯·æ±‚/å“åº”æ—¥å¿—
- Pipeline æ‰§è¡ŒçŠ¶æ€
- å·¥å…·è°ƒç”¨è®°å½•
- é”™è¯¯å †æ ˆ

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†
- FastAPI å¼‚æ­¥ç«¯ç‚¹
- å¼‚æ­¥ Pipeline æ‰§è¡Œ
- çº¿ç¨‹æ± éš”ç¦»

### 2. è¿æ¥æ± 
- HTTPx å®¢æˆ·ç«¯è¿æ¥æ± 
- æ•°æ®åº“è¿æ¥æ± ï¼ˆå¦‚éœ€è¦ï¼‰

### 3. ç¼“å­˜ç­–ç•¥
- Pipeline ç»„ä»¶é¢„åŠ è½½
- å·¥å…·å®šä¹‰ç¼“å­˜
- é…ç½®ç¼“å­˜

### 4. èµ„æºé™åˆ¶
```python
# é™åˆ¶å¹¶å‘ä»»åŠ¡æ•°
MAX_CONCURRENT_TASKS = 10

# è¶…æ—¶æ§åˆ¶
TASK_TIMEOUT = 300  # 5åˆ†é’Ÿ
```

## ğŸ”Œ æ‰©å±•æ€§

### 1. æ·»åŠ æ–°ç«¯ç‚¹
```python
# routers/custom.py
from fastapi import APIRouter

router = APIRouter()

@router.post("/v1/custom/endpoint")
async def custom_endpoint(request: CustomRequest):
    # å®ç°è‡ªå®šä¹‰é€»è¾‘
    pass
```

### 2. è‡ªå®šä¹‰äº‹ä»¶è¿‡æ»¤
```python
# services/data_filter.py
class DataFilter:
    def filter_message(self, message: dict) -> dict:
        # æ·»åŠ è‡ªå®šä¹‰è¿‡æ»¤é€»è¾‘
        pass
```

### 3. è‡ªå®šä¹‰æ ¼å¼è½¬æ¢
```python
# services/custom_adapter.py
class CustomAdapter:
    def convert_event(self, event: dict):
        # å®ç°è‡ªå®šä¹‰æ ¼å¼è½¬æ¢
        pass
```

## ğŸ³ Docker éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx Container  â”‚â”€â”€â”€â”€â”€â–¶â”‚  API Container     â”‚
â”‚   - åå‘ä»£ç†        â”‚      â”‚  - FastAPI         â”‚
â”‚   - é™æµ           â”‚      â”‚  - miroflow-agent  â”‚
â”‚   - SSL ç»ˆæ­¢       â”‚      â”‚  - Pipeline        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚                           â–¼
         â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                  â”‚  External Services â”‚
         â”‚                  â”‚  - LLM API         â”‚
         â”‚                  â”‚  - Serper API      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  - Jina API        â”‚
                            â”‚  - E2B API         â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ æœªæ¥æ”¹è¿›

### çŸ­æœŸ
- [ ] æ·»åŠ è®¤è¯ä¸­é—´ä»¶ï¼ˆJWT/API Keyï¼‰
- [ ] å®ç°è¯·æ±‚é€Ÿç‡é™åˆ¶
- [ ] æ·»åŠ  Prometheus ç›‘æ§æŒ‡æ ‡
- [ ] æ”¯æŒæ‰¹é‡è¯·æ±‚

### ä¸­æœŸ
- [ ] å®ç°ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCelery/Redisï¼‰
- [ ] æ·»åŠ  WebSocket æ”¯æŒ
- [ ] æ”¯æŒå¤šæ¨¡å‹è´Ÿè½½å‡è¡¡
- [ ] å®ç°ç»“æœç¼“å­˜

### é•¿æœŸ
- [ ] æ°´å¹³æ‰©å±•æ”¯æŒï¼ˆå¤šå®ä¾‹ï¼‰
- [ ] åˆ†å¸ƒå¼è¿½è¸ªï¼ˆOpenTelemetryï¼‰
- [ ] è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆKubernetesï¼‰
- [ ] å¤šç§Ÿæˆ·æ”¯æŒ

## ğŸ¤ è´¡çŒ®æŒ‡å—

### ä»£ç è§„èŒƒ
- ä½¿ç”¨ Black æ ¼å¼åŒ–ä»£ç 
- éµå¾ª PEP 8
- æ·»åŠ ç±»å‹æ³¨è§£
- ç¼–å†™å•å…ƒæµ‹è¯•

### æäº¤æµç¨‹
1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. ç¼–å†™ä»£ç å’Œæµ‹è¯•
4. æäº¤ PR

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](README.md) - é¡¹ç›®æ¦‚è¿°
- [QUICKSTART.md](QUICKSTART.md) - å¿«é€Ÿå¼€å§‹
- [../miroflow-agent/README.md](../miroflow-agent/README.md) - æ ¸å¿ƒæ¡†æ¶æ–‡æ¡£
- [OpenAI API Reference](https://platform.openai.com/docs/api-reference/chat) - API æ ¼å¼å‚è€ƒ

